// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client"
  output   = "../lib/generated/prisma"
  previewFeatures = ["driverAdapters"]
}

datasource db {
  provider = "postgresql"
}

// ========== App-wide enums ==========

enum Role {
  STUDENT
  ADMIN
}

// ========== NextAuth core models ==========

model User {
  id             String    @id @default(cuid())
  name           String?
  email          String?   @unique
  emailVerified  DateTime?
  image          String?

  // UGA identity
  ugaId          String?   @unique
  major          String?
  year           String?   // "Freshman", "Sophomore", etc.
  bio            String?

  phoneNumber    String?
  phoneVisible   Boolean   @default(true)

  // General meeting preferences (optional)
  meetingPrefs   String?

  // Global privacy preferences
  showGrades       Boolean  @default(true)
  showCourses      Boolean  @default(true)
  showTutorProfile Boolean  @default(true)

  // Role / permissions
  role           Role      @default(STUDENT)

  // Relations
  enrollments     Enrollment[]
  accounts        Account[]
  sessions        Session[]
  contactMethods  ContactMethod[]

  createdAt       DateTime   @default(now())
  updatedAt       DateTime   @updatedAt
}

model Account {
  id                 String   @id @default(cuid())
  userId             String
  user               User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  type               String
  provider           String
  providerAccountId  String

  refresh_token      String?
  access_token       String?
  expires_at         Int?
  token_type         String?
  scope              String?
  id_token           String?
  session_state      String?

  @@unique([provider, providerAccountId])
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  expires      DateTime
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}

// ========== App-specific models ==========

model Course {
  id          String        @id @default(cuid())

  // Split course code
  prefix      String        // e.g. "CSCI"
  number      String        // e.g. "1301" or "1107H"

  title       String
  description String?

  enrollments Enrollment[]

  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt

  @@unique([prefix, number])
}

model Enrollment {
  id          String   @id @default(cuid())
  userId      String
  courseId    String

  grade       String?  // "A", "B+", etc.

  // Tutoring flags
  canTutor    Boolean  @default(false)
  showAsTutor Boolean  @default(false)

  // Per-course privacy
  showGrade   Boolean  @default(true)

  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  course      Course   @relation(fields: [courseId], references: [id], onDelete: Cascade)

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@unique([userId, courseId])
}

model ContactMethod {
  id          String   @id @default(cuid())
  userId      String
  platform    String
  identifier  String

  isPreferred Boolean  @default(false)
  visible     Boolean  @default(true)

  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([userId])
}
